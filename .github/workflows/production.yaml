name: Deploy Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy'
        required: false
        default: 'latest'

permissions:
  contents: write

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment: main

    steps:
      - uses: actions/checkout@v5

      - uses: ./.github/composite
        
      - name: Zip dist folder
        run: |
                cd dist
                if [ "${{ inputs.version }}" = "latest" ]; then
                  zip -r ../latest-release.zip .
                else
                  zip -r ../v${{ inputs.version }}-release.zip .
                fi
                cd ..
        shell: bash

      - name: Upload Zip Artifact
        uses: actions/upload-artifact@v4
        with:
            name: ${{ inputs.version == 'latest' && 'latest-release' || format('v{0}-release', inputs.version) }}
            path: ${{ inputs.version == 'latest' && 'latest-release.zip' || format('v{0}-release.zip', inputs.version) }}

      - name: Cleanup Existing Release and Tag
        run: |
            if [ "${{ inputs.version }}" = "latest" ]; then
              gh release delete latest -y || echo "No existing release to delete"
              git push origin :refs/tags/latest || echo "No existing remote tag to delete"
            else
              if gh release view v${{ inputs.version }} > /dev/null 2>&1; then
                echo "Release v${{ inputs.version }} already exists. Aborting."
                exit 1
              fi
              git push origin :refs/tags/v${{ inputs.version }} || echo "No existing remote tag to delete"
            fi
        shell: bash
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create release
        run: |
            if [ "${{ inputs.version }}" = "latest" ]; then
              gh release create latest latest-release.zip \
                --title "Latest Release" \
                --target main \
                --prerelease \
                --notes "Automated latest build from commit ${{ github.sha }}"
            else
              gh release create v${{ inputs.version }} v${{ inputs.version }}-release.zip \
                --title "v${{ inputs.version }} Release" \
                --target main \
                --notes "Automated v${{ inputs.version }} build from commit ${{ github.sha }}"
            fi
        shell: bash
        env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
